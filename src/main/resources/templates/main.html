<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Card Management</title>

</head>
<body>
<h1>ë¦¬ë³¼ë¹™ Management</h1>

<button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

<h2>í˜„ì¬ ì •ë³´</h2>
<p>ìœ ì € ID: <span id="currentUserId">-</span></p>
<p>ìœ ì € ì´ë¦„: <span id="currentUserName">-</span></p>
<p>í˜„ì¬ ë¹š: <span id="currentDebt">-</span></p>
<p>ì´ììœ¨: <span id="currentInterest">-</span></p>
<p>ì´ë²ˆ ë‹¬ ì†Œë“: <span id="currentIncome">-</span></p>
<p>ì´ë²ˆ ë‹¬ ì†Œë¹„: <span id="currentExpense">-</span></p>


<h2>1. ë¹š ìˆ˜ì •</h2>
<input type="number" id="newDebt" placeholder="ë¹š ì•¡ìˆ˜ ì…ë ¥">
<button onclick="updateDebt()">ë¹š ìˆ˜ì •</button>
<input type="number" id="newInterest" placeholder="ì´ììœ¨ ì…ë ¥">
<button onclick="updateInterest()">ì´ììœ¨ ìˆ˜ì •</button>


<h2>2. ì´ë²ˆ ë‹¬ ì†Œë“ & ì†Œë¹„ ì…ë ¥</h2>
<h3>ì†Œë“</h3>
<input type="number" id="income" placeholder="ì†Œë“ ì…ë ¥">
<h3>ì†Œë¹„</h3>
<input type="number" id="expense" placeholder="ì†Œë¹„ ì…ë ¥">
<button onclick="updateIncomeExpense()">ì†Œë“ & ì†Œë¹„ ì…ë ¥</button>



<h2>3. 1ë‹¬ ë³´ë‚´ê¸°</h2>
<button onclick="applyMonthlyUpdate()">1ë‹¬ ë³´ë‚´ê¸°</button>

<h2>4. ì‹œë®¬ë ˆì´í„°</h2>
<h3>ì›” ì†Œë“(ì‹œë®¬ìš©)</h3>
<input type="number" id="monthlyIncome" placeholder="ì›” ì†Œë“ ì…ë ¥">
<h3>ì›” ì†Œë¹„(ì‹œë®¬ìš©)</h3>
<input type="number" id="monthlyExpense" placeholder="ì›” ì†Œë¹„ ì…ë ¥">
<button onclick="simulator()">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>

<div id="simulatorResult"></div>

<script>
    async function logout(){
        console.log("doing logout");
        fetch("/auth/logout", { method: "POST",credentials: "same-origin" // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
        }).then(response => {
            if (response.ok) {
                alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤!");
                window.location.href = "/"; // âœ… ë¡œê·¸ì•„ì›ƒ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
            } else {
                alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨!");
            }
        }).catch(error => console.error("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error));
    }

    async function fetchUserData() {
        const userId = parseFloat(document.getElementById("currentUserId").textContent);
        if (!userId || userId<=0) return;

        const response = await fetch(`/users/${userId}`);
        if (!response.ok) {
            alert("ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        const user = await response.json();

        document.getElementById("currentUserId").textContent = user.id;
        document.getElementById("currentUserName").textContent = user.name;
        document.getElementById("currentDebt").textContent = user.debt;
        document.getElementById("currentInterest").textContent = user.interestRate;
        document.getElementById("currentIncome").textContent = user.income;
        document.getElementById("currentExpense").textContent = user.expense;
    }

    console.log("abc");
    fetch("/auth/me").then(response => {
            if (!response.ok) {
                throw new Error("ğŸš¨ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ!");
            }
            return response.json();
        })
        .then(data => {
            document.getElementById("currentUserId").textContent = data.id;
            fetchUserData();
        })
        .catch(error => {
            console.error("ğŸš¨ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
        });






    async function updateDebt() {
        const userId = parseFloat(document.getElementById("currentUserId").textContent);
        const newDebt = document.getElementById("newDebt").value;
        await fetch(`/users/${userId}/debt?newDebt=${newDebt}`, { method: "PUT" });
        fetchUserData();
    }

    async function updateInterest() {
        const userId = parseFloat(document.getElementById("currentUserId").textContent);
        const newInterest = document.getElementById("newInterest").value;
        await fetch(`/users/${userId}/interest?newInterest=${newInterest}`, { method: "PUT" });
        fetchUserData();
    }

    async function updateIncomeExpense() {
        const userId = parseFloat(document.getElementById("currentUserId").textContent);
        const income = document.getElementById("income").value;
        const expense = document.getElementById("expense").value;
        await fetch(`/users/${userId}/income-expense?income=${income}&expense=${expense}`, { method: "PUT" });
        fetchUserData();
    }

    async function applyMonthlyUpdate() {
        const userId = parseFloat(document.getElementById("currentUserId").textContent);
        await fetch(`/users/${userId}/apply-month`, { method: "POST" });
        fetchUserData();
    }

    async function simulator(){
        const userId = parseFloat(document.getElementById("currentUserId").textContent);
        const monthlyIncome = document.getElementById("monthlyIncome").value;
        const monthlyExpense = document.getElementById("monthlyExpense").value;
        const response = await fetch(`/users/${userId}/simulation?monthlyIncome=${monthlyIncome}&monthlyExpense=${monthlyExpense}`);

        const monthsText = await response.text();
        const months = parseInt(monthsText, 10); // ë¬¸ìì—´ì„ ì •ìˆ˜ë¡œ ë³€í™˜

        if (isNaN(months)) {
            document.getElementById("simulatorResult").innerHTML =
                `<h3>ì˜¬ë°”ë¥¸ ì…ë ¥ì´ ì•„ë‹™ë‹ˆë‹¤</h3>`;
        }
        else if (months === -1) {
            document.getElementById("simulatorResult").innerHTML =
                `<h3>âŒ ë¹šì„ ê°šì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì†Œë“ì´ ì´ìë³´ë‹¤ ë‚®ìŒ)</h3>`;
        } else {
            document.getElementById("simulatorResult").innerHTML =
                `<h3>âœ… ì´ ${months}ê°œì›” í›„ì— ë¹šì„ ë‹¤ ê°šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</h3>`;
        }
    }
</script>

</body>
</html>


